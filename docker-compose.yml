version: "3.2"
services:
  volumes:
    pgdata:
        driver: local

services:
   db:
      container_name: db
      image: postgres
      environment:
         POSTGRES_USER: admin
         POSTGRES_PASSWORD: '123456'
         POSTGRES_DB: netdb
         PGDATA: /var/lib/postgresql/data/pgdata
      volumes:
         - ./pgdata/:/var/lib/postgresql/data/pgdata

   web:
      restart: always
      build:
         context: .
         dockerfile: dockerfile
      volumes:
         - ./:/srv/www/net/
      ports:
         - 8000:8000
      command: "bash entrypoint.sh"
      env_file:
         - env.conf
      depends_on:
         - front

   front:
      image: node:latest
      volumes:
         - ./front:/srv/www/net/front/
      working_dir: /srv/www/net/front/
      command: bash -c "yarn install && yarn run build"
      depends_on:
         - db

   nginx:
      restart: always
      image: nginx
      expose:
         - 8080
      ports:
         - 8080:8080
      volumes:
         - ./net/static/:/srv/www/net/static/
         - ./net/logs:/srv/www/net/logs
         - ./nginx-server.conf:/etc/nginx/conf.d/default.conf
      depends_on:
         - web
